{% extends "base.html" %}

{% block title %}Simple Progress Test - Free Ping Indexer Pro{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1>Simple Live Progress Test</h1>
            <p class="lead">Click the button below to test the live progress tracking system.</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5>Test Campaign</h5>
                </div>
                <div class="card-body">
                    <button id="start-test" class="btn btn-primary btn-lg">
                        <i class="fas fa-play me-2"></i>Start Progress Test
                    </button>
                    <div id="test-output" class="mt-3"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5>Service Stats</h5>
                </div>
                <div class="card-body" id="service-info">
                    <div class="text-center">
                        <div class="spinner-border"></div>
                        <p>Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Progress Display -->
    <div class="row mt-4">
        <div class="col-12">
            <div id="progress-container"></div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const startBtn = document.getElementById('start-test');
    const output = document.getElementById('test-output');
    const serviceInfo = document.getElementById('service-info');
    const progressContainer = document.getElementById('progress-container');

    let currentCampaignId = null;
    let progressInterval = null;

    // Load service info
    loadServiceInfo();

    startBtn.addEventListener('click', function() {
        startProgressTest();
    });

    async function loadServiceInfo() {
        try {
            const response = await fetch('/api/service-categories');
            const data = await response.json();
            
            let html = `<div class="row">`;
            if (data.stats) {
                html += `
                    <div class="col-6">
                        <strong>Total Services:</strong><br>
                        <span class="h4 text-success">${data.stats.total || 0}</span>
                    </div>
                    <div class="col-6">
                        <strong>Categories:</strong><br>
                        <span class="h4 text-info">${data.categories ? data.categories.length : 0}</span>
                    </div>
                `;
            }
            html += `</div>`;
            
            serviceInfo.innerHTML = html;
        } catch (error) {
            serviceInfo.innerHTML = `<div class="text-danger">Error loading service info: ${error.message}</div>`;
        }
    }

    async function startProgressTest() {
        // Disable button
        startBtn.disabled = true;
        startBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Starting...';

        try {
            const response = await fetch('/api/start-live-campaign', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    urls: ['https://example.com', 'https://google.com'],
                    categories: ['modern_ping_services', 'seo_tools']
                })
            });

            const result = await response.json();
            
            if (result.success) {
                currentCampaignId = result.campaign_id;
                output.innerHTML = `
                    <div class="alert alert-success">
                        <strong>Campaign Started!</strong><br>
                        ID: ${result.campaign_id}<br>
                        URLs: ${result.total_urls}<br>
                        Services: ${result.total_services}<br>
                        Total Pings: ${result.total_pings}
                    </div>
                `;
                
                createProgressDisplay(result);
                startProgressTracking();
            } else {
                output.innerHTML = `<div class="alert alert-danger">Error: ${result.error}</div>`;
                resetButton();
            }
        } catch (error) {
            output.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            resetButton();
        }
    }

    function createProgressDisplay(campaignData) {
        progressContainer.innerHTML = `
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5>Live Progress - ${campaignData.campaign_id}</h5>
                </div>
                <div class="card-body">
                    <div class="progress mb-3" style="height: 30px;">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                             style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            <span id="progress-text">0%</span>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Current Status:</h6>
                            <div id="current-status" class="alert alert-info">Starting...</div>
                        </div>
                        <div class="col-md-6">
                            <h6>Statistics:</h6>
                            <div id="stats-display">
                                <div>Successful: <span id="success-count">0</span></div>
                                <div>Failed: <span id="failed-count">0</span></div>
                                <div>Success Rate: <span id="success-rate">0%</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-warning" onclick="stopTracking()">
                            <i class="fas fa-stop me-2"></i>Stop Tracking
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    function startProgressTracking() {
        if (!currentCampaignId) return;
        
        progressInterval = setInterval(async () => {
            try {
                const response = await fetch(`/api/campaign-progress/${currentCampaignId}`);
                
                if (!response.ok) {
                    console.log('Campaign completed or not found');
                    stopTracking();
                    return;
                }
                
                const data = await response.json();
                updateProgressDisplay(data);
                
                if (data.status === 'completed') {
                    stopTracking();
                    showCompletion();
                }
            } catch (error) {
                console.error('Error fetching progress:', error);
            }
        }, 1000); // Update every second
    }

    function updateProgressDisplay(data) {
        // Update progress bar
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        
        if (progressBar && progressText) {
            progressBar.style.width = `${data.percentage}%`;
            progressBar.setAttribute('aria-valuenow', data.percentage);
            progressText.textContent = `${data.percentage.toFixed(1)}%`;
        }

        // Update current status
        const currentStatus = document.getElementById('current-status');
        if (currentStatus && data.current_service) {
            const serviceName = extractServiceName(data.current_service);
            currentStatus.innerHTML = `
                <strong>Submitting to: ${serviceName}</strong><br>
                <small class="text-muted">${data.current_service}</small>
            `;
        }

        // Update statistics
        const successCount = document.getElementById('success-count');
        const failedCount = document.getElementById('failed-count');
        const successRate = document.getElementById('success-rate');

        if (successCount) successCount.textContent = data.successful || 0;
        if (failedCount) failedCount.textContent = data.failed || 0;
        if (successRate) successRate.textContent = `${data.success_rate || 0}%`;
    }

    function extractServiceName(url) {
        try {
            const domain = new URL(url).hostname;
            return domain.replace('www.', '').split('.')[0];
        } catch {
            return 'Service';
        }
    }

    function showCompletion() {
        const header = progressContainer.querySelector('.card-header');
        if (header) {
            header.className = 'card-header bg-success text-white';
            header.innerHTML = '<h5><i class="fas fa-check-circle me-2"></i>Campaign Complete!</h5>';
        }

        const progressBar = document.getElementById('progress-bar');
        if (progressBar) {
            progressBar.classList.remove('progress-bar-animated');
        }

        resetButton();
    }

    function stopTracking() {
        if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
        }
        resetButton();
    }

    function resetButton() {
        startBtn.disabled = false;
        startBtn.innerHTML = '<i class="fas fa-play me-2"></i>Start Progress Test';
    }

    // Make stopTracking available globally
    window.stopTracking = stopTracking;
});
</script>
{% endblock %}