{% extends "base.html" %}

{% block title %}Live Progress Demo - Free Ping Indexer Pro{% endblock %}

{% block extra_head %}
<style>
    .service-category {
        transition: all 0.3s ease;
    }
    .service-category:hover {
        background-color: rgba(0,123,255,0.1);
        border-left: 4px solid #007bff;
    }
    .progress-demo {
        min-height: 200px;
    }
    #live-progress {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1>
                <i class="fas fa-tachometer-alt me-2"></i>
                Live Progress Demo
            </h1>
            <p class="lead">Test the real-time progress tracking system with live updates showing percentage completion and current service submissions.</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Start Live Progress Demo</h5>
                </div>
                <div class="card-body">
                    <form id="live-demo-form">
                        <div class="mb-3">
                            <label for="demo-urls" class="form-label">Test URLs (one per line)</label>
                            <textarea id="demo-urls" class="form-control" rows="4" placeholder="https://example.com
https://google.com
https://github.com">https://example.com
https://google.com
https://github.com</textarea>
                            <small class="form-text text-muted">Enter URLs to test ping submissions</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Service Categories to Use</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="service-category p-2 mb-2 border rounded">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="modern_ping_services" id="cat-modern" checked>
                                            <label class="form-check-label" for="cat-modern">
                                                <strong>Modern Ping Services</strong>
                                                <small class="d-block text-muted">Latest high-performance services</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="service-category p-2 mb-2 border rounded">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="seo_tools" id="cat-seo" checked>
                                            <label class="form-check-label" for="cat-seo">
                                                <strong>SEO Tools</strong>
                                                <small class="d-block text-muted">Professional SEO ping services</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="service-category p-2 mb-2 border rounded">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="google_services" id="cat-google">
                                            <label class="form-check-label" for="cat-google">
                                                <strong>Google Services</strong>
                                                <small class="d-block text-muted">Google FeedBurner, PubSubHub</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="service-category p-2 mb-2 border rounded">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="bulk_ping" id="cat-bulk">
                                            <label class="form-check-label" for="cat-bulk">
                                                <strong>Bulk Ping</strong>
                                                <small class="d-block text-muted">High-volume processing</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="service-category p-2 mb-2 border rounded">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="developer_tools" id="cat-dev">
                                            <label class="form-check-label" for="cat-dev">
                                                <strong>Developer Tools</strong>
                                                <small class="d-block text-muted">Technical ping services</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="service-category p-2 mb-2 border rounded">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="blog_ping" id="cat-blog">
                                            <label class="form-check-label" for="cat-blog">
                                                <strong>Blog Ping</strong>
                                                <small class="d-block text-muted">Blog-specific services</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="service-category p-2 mb-2 border rounded">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="global_rss" id="cat-rss">
                                            <label class="form-check-label" for="cat-rss">
                                                <strong>Global RSS</strong>
                                                <small class="d-block text-muted">Traditional RSS services</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="start-demo-btn">
                                <i class="fas fa-play me-2"></i>Start Live Progress Demo
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Service Statistics</h6>
                </div>
                <div class="card-body">
                    <div id="service-stats">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading service data...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">Active Campaigns</h6>
                </div>
                <div class="card-body">
                    <div id="active-campaigns">
                        <p class="text-muted">No active campaigns</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress display area (initially hidden) -->
    <div class="row mt-4">
        <div class="col-12">
            <div id="live-progress-container"></div>
        </div>
    </div>
</div>

<script>
class LiveProgressDemo {
    constructor() {
        this.form = document.getElementById('live-demo-form');
        this.startBtn = document.getElementById('start-demo-btn');
        this.progressContainer = document.getElementById('live-progress-container');
        this.currentCampaignId = null;
        
        this.setupEventListeners();
        this.loadServiceStats();
        this.loadActiveCampaigns();
        
        // Auto-refresh active campaigns every 5 seconds
        setInterval(() => this.loadActiveCampaigns(), 5000);
    }

    setupEventListeners() {
        this.form.addEventListener('submit', (e) => {
            e.preventDefault();
            this.startDemo();
        });
    }

    async loadServiceStats() {
        try {
            const response = await fetch('/api/service-categories');
            const data = await response.json();
            
            if (data.stats) {
                this.displayServiceStats(data.stats);
            }
        } catch (error) {
            console.error('Error loading service stats:', error);
        }
    }

    displayServiceStats(stats) {
        const container = document.getElementById('service-stats');
        let html = '';
        
        for (const [category, count] of Object.entries(stats)) {
            if (category !== 'total') {
                html += `
                    <div class="d-flex justify-content-between mb-2">
                        <span>${category.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                        <badge class="badge bg-primary">${count}</badge>
                    </div>
                `;
            }
        }
        
        html += `
            <hr>
            <div class="d-flex justify-content-between">
                <strong>Total Services</strong>
                <strong class="badge bg-success">${stats.total || 0}</strong>
            </div>
        `;
        
        container.innerHTML = html;
    }

    async loadActiveCampaigns() {
        try {
            const response = await fetch('/api/active-campaigns');
            const campaigns = await response.json();
            
            this.displayActiveCampaigns(campaigns);
        } catch (error) {
            console.error('Error loading active campaigns:', error);
        }
    }

    displayActiveCampaigns(campaigns) {
        const container = document.getElementById('active-campaigns');
        
        if (Object.keys(campaigns).length === 0) {
            container.innerHTML = '<p class="text-muted">No active campaigns</p>';
            return;
        }
        
        let html = '';
        for (const [id, campaign] of Object.entries(campaigns)) {
            const statusColor = campaign.status === 'running' ? 'warning' : 'success';
            html += `
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">${id}</small>
                        <span class="badge bg-${statusColor}">${campaign.status}</span>
                    </div>
                    <div class="progress progress-sm mt-1">
                        <div class="progress-bar" style="width: ${campaign.progress}%"></div>
                    </div>
                    <small class="text-muted">${campaign.progress}% complete</small>
                </div>
            `;
        }
        
        container.innerHTML = html;
    }

    async startDemo() {
        // Get form data
        const urlsText = document.getElementById('demo-urls').value;
        const urls = urlsText.split('\n').filter(url => url.trim()).map(url => url.trim());
        
        const selectedCategories = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
            .map(cb => cb.value);
        
        if (urls.length === 0) {
            alert('Please enter at least one URL');
            return;
        }
        
        if (selectedCategories.length === 0) {
            alert('Please select at least one service category');
            return;
        }
        
        // Disable form
        this.startBtn.disabled = true;
        this.startBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Starting...';
        
        try {
            const response = await fetch('/api/start-live-campaign', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    urls: urls,
                    categories: selectedCategories
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                this.currentCampaignId = result.campaign_id;
                this.showProgress(result);
                this.startProgressPolling();
            } else {
                alert('Error: ' + result.error);
                this.resetForm();
            }
        } catch (error) {
            console.error('Error starting demo:', error);
            alert('Error starting demo: ' + error.message);
            this.resetForm();
        }
    }

    showProgress(campaignData) {
        const html = `
            <div id="live-progress" class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-sync fa-spin me-2"></i>
                        Live Progress - ${campaignData.campaign_id}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <div class="progress mb-2" style="height: 25px;">
                                <div id="main-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                     role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                    <span id="progress-percentage">0%</span>
                                </div>
                            </div>
                            <small class="text-muted">
                                <span id="progress-stats">0 of ${campaignData.total_pings} pings processed</span>
                            </small>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="d-flex flex-column">
                                <span class="badge bg-info mb-1" id="current-status">Starting...</span>
                                <small class="text-muted" id="estimated-time">Estimating time...</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Currently Submitting To:</h6>
                            <div id="current-service" class="alert alert-info py-2">
                                <i class="fas fa-clock me-2"></i>Initializing...
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Recent Activity:</h6>
                            <div id="activity-log" class="bg-light p-2 rounded" style="height: 120px; overflow-y: auto; font-size: 0.85em;">
                                <div class="text-muted">Campaign started...</div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="row text-center">
                                <div class="col-3">
                                    <div class="card bg-success text-white">
                                        <div class="card-body py-2">
                                            <div class="h4 mb-0" id="success-count">0</div>
                                            <small>Successful</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="card bg-danger text-white">
                                        <div class="card-body py-2">
                                            <div class="h4 mb-0" id="failed-count">0</div>
                                            <small>Failed</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="card bg-warning text-white">
                                        <div class="card-body py-2">
                                            <div class="h4 mb-0" id="pending-count">${campaignData.total_pings}</div>
                                            <small>Pending</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="card bg-info text-white">
                                        <div class="card-body py-2">
                                            <div class="h4 mb-0" id="success-rate">0%</div>
                                            <small>Success Rate</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-3">
                        <button class="btn btn-warning" onclick="this.stopDemo()">
                            <i class="fas fa-stop me-2"></i>Stop Demo
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        this.progressContainer.innerHTML = html;
    }

    startProgressPolling() {
        if (!this.currentCampaignId) return;
        
        this.progressInterval = setInterval(async () => {
            try {
                const response = await fetch(`/api/campaign-progress/${this.currentCampaignId}`);
                if (!response.ok) {
                    console.warn('Campaign progress not found, stopping polling');
                    this.stopProgressPolling();
                    return;
                }
                
                const data = await response.json();
                this.updateProgressDisplay(data);
                
                if (data.status === 'completed') {
                    this.stopProgressPolling();
                    this.showCompletion();
                }
            } catch (error) {
                console.error('Error fetching progress:', error);
            }
        }, 1000);
    }

    updateProgressDisplay(data) {
        // Update progress bar
        const progressBar = document.getElementById('main-progress-bar');
        const progressPercentage = document.getElementById('progress-percentage');
        const progressStats = document.getElementById('progress-stats');

        if (progressBar && progressPercentage && progressStats) {
            progressBar.style.width = `${data.percentage}%`;
            progressBar.setAttribute('aria-valuenow', data.percentage);
            progressPercentage.textContent = `${data.percentage.toFixed(1)}%`;
            progressStats.textContent = `${data.processed} of ${data.total} pings processed`;
        }

        // Update current service
        const currentServiceElement = document.getElementById('current-service');
        if (currentServiceElement && data.current_service) {
            const serviceName = this.extractServiceName(data.current_service);
            currentServiceElement.innerHTML = `
                <i class="fas fa-paper-plane me-2"></i>
                <strong>${serviceName}</strong>
                <br><small class="text-muted">${data.current_service}</small>
            `;
        }

        // Update stats
        const successCount = document.getElementById('success-count');
        const failedCount = document.getElementById('failed-count');
        const pendingCount = document.getElementById('pending-count');
        const successRate = document.getElementById('success-rate');

        if (successCount) successCount.textContent = data.successful || 0;
        if (failedCount) failedCount.textContent = data.failed || 0;
        if (pendingCount) pendingCount.textContent = data.pending || 0;
        if (successRate) successRate.textContent = `${data.success_rate || 0}%`;

        // Update activity log
        this.updateActivityLog(data.recent_activities || []);
    }

    updateActivityLog(activities) {
        const activityLog = document.getElementById('activity-log');
        if (!activityLog || !activities.length) return;

        // Keep only the most recent activities
        const recentActivities = activities.slice(0, 5);
        
        let html = '';
        recentActivities.forEach(activity => {
            const serviceName = this.extractServiceName(activity.service);
            const statusIcon = activity.success ? 'fa-check text-success' : 'fa-times text-danger';
            html += `
                <div class="mb-1">
                    <i class="fas ${statusIcon} me-1"></i>
                    <small>${serviceName} - ${activity.timestamp}</small>
                </div>
            `;
        });
        
        activityLog.innerHTML = html;
    }

    extractServiceName(url) {
        try {
            const domain = new URL(url).hostname;
            return domain.replace('www.', '').split('.')[0];
        } catch {
            return 'Service';
        }
    }

    showCompletion() {
        const header = document.querySelector('#live-progress .card-header h5');
        if (header) {
            header.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                Campaign Complete - ${this.currentCampaignId}
            `;
            header.parentElement.className = 'card-header bg-success text-white';
        }

        // Stop animations
        const progressBar = document.getElementById('main-progress-bar');
        if (progressBar) {
            progressBar.classList.remove('progress-bar-animated');
        }

        this.resetForm();
    }

    stopProgressPolling() {
        if (this.progressInterval) {
            clearInterval(this.progressInterval);
            this.progressInterval = null;
        }
    }

    stopDemo() {
        this.stopProgressPolling();
        this.currentCampaignId = null;
        this.progressContainer.innerHTML = '';
        this.resetForm();
    }

    resetForm() {
        this.startBtn.disabled = false;
        this.startBtn.innerHTML = '<i class="fas fa-play me-2"></i>Start Live Progress Demo';
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    window.liveProgressDemo = new LiveProgressDemo();
});
</script>
{% endblock %}